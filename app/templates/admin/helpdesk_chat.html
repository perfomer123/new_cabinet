{% extends "admin/base_admin.html" %}
{% block title %}Чат тикета #{{ ticket.id }} - Helpdesk{% endblock %}
{% block page_title_text %}Чат тикета #{{ ticket.id }}{% endblock %}
{% block admin_content %}
<div class="container py-2" style="max-width: 900px;">
  <div class="mb-3">
    <a href="/helpdesk" class="btn btn-outline-secondary">
      ← Назад к списку тикетов
    </a>
    <div class="ms-3 d-inline-block">
      <span class="text-muted">Тикет #{{ ticket.id }} - {{ ticket.subject }}</span><br>
    </div>
      <small class="text-muted">
        {% if user_data.identifier %}
          ID: <a href="/client/{{ user_data.identifier }}" target="_blank">{{ user_data.ext_user_id or user_data.identifier }}</a>
        {% elif ticket.user_id %}
          ID: {{ ticket.user_id }}
        {% endif %}
        {% if user_data.key %}
          {% if user_data.identifier or ticket.user_id %}|{% endif %} 
          Ключ: <a href="/key_access/{{ user_data.key }}" target="_blank">{{ user_data.key }}</a>
        {% endif %}
      </small>
  </div>
  <div class="card shadow-sm">
    <div class="card-body" id="messages" style="height: 500px; overflow-y:auto; background:#f9fafb;"></div>
    <div class="card-footer bg-white">
      <div class="d-flex align-items-end" style="gap: 10px;">
        <textarea id="msg" class="form-control" placeholder="Ваш ответ... (Ctrl+Enter или Cmd+Enter для отправки)" rows="1" style="resize: none; overflow: hidden; min-height: 38px; flex: 1;"></textarea>
        <button id="send" class="btn btn-primary" style="height: 38px;">Отправить</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
const ticketId = {{ ticket.id }};
const messagesEl = document.getElementById('messages');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');

// Функция автоматического изменения размера textarea
function autoResize() {
  msgInput.style.height = 'auto';
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px'; // Максимум 120px высоты
}

// Добавляем обработчик для автоизменения размера
msgInput.addEventListener('input', autoResize);
msgInput.addEventListener('change', autoResize);

function appendMessage(m) {
  const wrap = document.createElement('div');
  wrap.className = 'mb-2';
  const who = m.author_type === 'admin' ? 'Админ' : 'Пользователь';
  
  // Разные стили для админа и пользователя
  const bgColor = m.author_type === 'admin' ? 'bg-primary bg-opacity-10 border-primary' : 'bg-light border-secondary';
  const textColor = m.author_type === 'admin' ? 'text-primary' : 'text-dark';
  
  wrap.innerHTML = `<div class="small text-muted">${who} • ${m.created_at||''}</div><div class="p-2 rounded ${bgColor} ${textColor} border">${(m.text||'').replaceAll('<','&lt;').replaceAll('\n', '<br>')}</div>`;
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function loadHistory() {
  try {
    const resp = await fetch(`/api/helpdesk/tickets/${ticketId}/messages`, {credentials: 'include'});
    const data = await resp.json();
    (data.messages||[]).forEach(appendMessage);
  } catch (e) {
    console.error('Failed to load history:', e);
  }
}

loadHistory();

const token = (document.cookie.match(/(?:^|; )token=([^;]+)/)||[])[1] || '';
const socket = io('/helpdesk', {
  transports: ['websocket', 'polling'],
  query: {token}
});

socket.on('connect', () => {
  console.log('Connected to helpdesk');
  socket.emit('join', {ticket_id: ticketId});
});

socket.on('message:new', (data) => {
  appendMessage(data);
});

// Функция отправки сообщения
async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  
  msgInput.value = '';
  msgInput.style.height = '38px'; // Сброс высоты после отправки
  msgInput.focus();
  
  // Если WebSocket подключен, отправляем через него
  if (socket && socket.connected) {
    socket.emit('message:send', {ticket_id: ticketId, text});
  } else {
    // Fallback на REST API
    try {
      const resp = await fetch(`/api/helpdesk/tickets/${ticketId}/messages`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({text})
      });
      const data = await resp.json();
      if (data.status === 'success' && data.message) {
        appendMessage(data.message);
      }
    } catch (e) {
      console.error('Failed to send message:', e);
      alert('Ошибка отправки сообщения');
    }
  }
}

// Обработчик кнопки отправки
sendBtn.onclick = sendMessage;

// Добавляем обработчик клавиатуры для Ctrl+Enter и Cmd+Enter
msgInput.addEventListener('keydown', (e) => {
  // Проверяем Ctrl+Enter (Windows/Linux) или Cmd+Enter (Mac)
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    sendMessage();
  }
  // Обычный Enter - ничего не делаем, пусть работает как перенос строки
});
</script>
{% endblock %}
