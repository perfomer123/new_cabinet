# Модуль управления ключами (Keys Management)

Этот модуль предоставляет функциональность для управления ключами пользователей в системе Сова Мониторинг.

## Структура модуля

```
app/keys_management/
├── __init__.py          # Инициализация Blueprint
├── routes.py            # Маршруты и обработчики
├── utils.py             # Утилиты для работы с данными
└── README.md           # Документация
```

## Функциональность

### Основные возможности

1. **Просмотр ключей пользователей** - отображение всех ключей с информацией о пользователях
2. **Фильтрация данных** - поиск по email, телефону, ключу, названию ключа, датам, статусу, тарифу
3. **Пагинация** - поддержка больших объемов данных
4. **API для AJAX запросов** - REST API для динамической загрузки данных

### Маршруты

- `GET /keys_management` - основная страница управления ключами
- `GET /api/keys_management` - API для получения данных с фильтрацией

### Безопасность

- Аутентификация обязательна для всех маршрутов
- Доступ только для пользователей с ролью 'admin'
- Автоматическое перенаправление на страницу входа

## Использование

### Для администраторов

1. Войдите в систему как администратор
2. Перейдите в раздел "Управление ключами" в навигации
3. Используйте фильтры для поиска нужных данных
4. Просматривайте детальную информацию о ключах

### API

```javascript
// Пример AJAX запроса
fetch('/api/keys_management?page=1&per_page=50&email=user@example.com')
  .then(response => response.json())
  .then(data => {
    console.log(data.data); // массив записей
    console.log(data.total); // общее количество
  });
```

## Технические детали

### База данных

Модуль работает с вторичной базой данных `/root/miner-data/file.db` и использует следующие таблицы:

- `users` - пользователи системы
- `user_keys` - ключи пользователей
- `tariffs` - тарифы
- `user_tariffs` - связь пользователей с тарифами
- `miner_data` - данные майнеров

### Обработка данных

1. **Получение данных** - функция `get_data_for_user()` загружает данные в зависимости от роли пользователя
2. **Обработка** - функция `process_keys_data()` форматирует и структурирует данные для отображения
3. **Фильтрация** - поддержка множественных фильтров с поиском по подстроке
4. **Пагинация** - разбивка больших объемов данных на страницы

### Шаблоны

Используется шаблон `app/templates/keys_management/index.html` с:
- Современным дизайном Bootstrap 5
- Адаптивной таблицей
- Интерактивными фильтрами
- Пагинацией

## Разработка

### Добавление новых функций

1. Создайте новые маршруты в `routes.py`
2. Добавьте утилиты в `utils.py` при необходимости
3. Обновите шаблоны в `templates/keys_management/`
4. Добавьте тесты

### Структура данных

```python
# Структура данных ключа
{
    'key': 'ключ_устройства',
    'key_name': 'название_ключа',
    'start_date': 'дата_начала',
    'end_date': 'дата_окончания',
    'status': 'статус',
    'name': 'название_тарифа'
}

# Структура данных пользователя
{
    'email': 'email@example.com',
    'phone_number': '+7XXXXXXXXXX',
    'keys': [список_ключей]
}
```

## Зависимости

- Flask
- pandas
- sqlite3
- Bootstrap 5 (для фронтенда)

## История

Модуль создан путем рефакторинга функциональности из `create_summary_table.py` для улучшения архитектуры приложения и разделения ответственности. 